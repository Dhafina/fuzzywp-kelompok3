<!doctype html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuzzy Weighted Product Calculator</title>
    <script src="/_sdk/element_sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Quicksand', 'Poppins', sans-serif;
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            min-height: 100%;
            font-size: 16px;
        }

        * {
            box-sizing: border-box;
        }

        .app-container {
            width: 100%;
            min-height: 100%;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            text-align: center;
            color: #6b5b95;
            margin-bottom: 30px;
            padding: 20px;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }

        .header h1 {
            font-size: 42px;
            font-weight: 700;
            margin: 0 0 20px 0;
            letter-spacing: -1px;
            line-height: 1.3;
        }

        .header p {
            font-size: 18px;
            margin: 0;
            line-height: 1.6;
            color: #8b7ba8;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background: #e8d5f2;
            z-index: 0;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .step-circle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #f3e8ff;
            color: #9b7ba8;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 600;
            transition: all 0.3s;
            border: 3px solid #e8d5f2;
            font-size: 16px;
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, #a6c1ee 0%, #fbc2eb 100%);
            color: white;
            border-color: #a6c1ee;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(166, 193, 238, 0.4);
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        .step.completed .step-circle {
            background: #b4a7d6;
            color: white;
            border-color: #b4a7d6;
        }

        .step-label {
            font-size: 14px;
            color: #6b5b95;
            font-weight: 500;
            line-height: 1.4;
        }

        .step.active .step-label {
            color: #6b5b95;
            font-weight: 700;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #6b5b95;
            margin-bottom: 8px;
            font-size: 15px;
            line-height: 1.5;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e8d5f2;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            font-family: 'Quicksand', sans-serif;
            background: white;
            color: #6b5b95;
        }

        input:focus,
        select:focus {
            outline: none;
            background: #fef9ff;
            border-color: #a6c1ee;
            box-shadow: 0 0 0 4px rgba(166, 193, 238, 0.1);
        }

        input::placeholder {
            color: #b4a7d6;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            padding: 16px 35px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Quicksand', sans-serif;
            text-transform: none;
            line-height: 1.5;
        }

        .btn-primary {
            background: linear-gradient(135deg, #a6c1ee 0%, #fbc2eb 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(166, 193, 238, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(166, 193, 238, 0.5);
        }

        .btn-secondary {
            background: #e8d5f2;
            color: #6b5b95;
            box-shadow: 0 4px 15px rgba(232, 213, 242, 0.4);
        }

        .btn-secondary:hover {
            background: #d4c5e0;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 197, 224, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, #b4a7d6 0%, #a6c1ee 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(180, 167, 214, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(180, 167, 214, 0.5);
        }

        .btn-danger {
            background: #ffccd5;
            color: #d65076;
            padding: 10px 20px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(255, 204, 213, 0.3);
        }

        .btn-danger:hover {
            background: #ffb3c1;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 179, 193, 0.4);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .dynamic-list {
            margin-top: 20px;
        }

        .list-item {
            background: #fef9ff;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #f3e8ff;
            transition: all 0.3s;
        }

        .list-item:hover {
            background: white;
            border-color: #e8d5f2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 91, 149, 0.1);
        }

        .list-item-content {
            flex: 1;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 12px;
            border: 2px solid #e8d5f2;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #a6c1ee 0%, #fbc2eb 100%);
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
            font-size: 15px;
            border: none;
        }

        td {
            padding: 15px 18px;
            border: 1px solid #f3e8ff;
            font-size: 15px;
            background: white;
            color: #6b5b95;
        }

        tr:hover td {
            background: #fef9ff;
        }

        .result-card {
            background: linear-gradient(135deg, #a6c1ee 0%, #fbc2eb 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: none;
            box-shadow: 0 10px 30px rgba(166, 193, 238, 0.3);
        }

        .result-card h2 {
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 600;
            line-height: 1.4;
        }

        .result-card .winner {
            font-size: 36px;
            font-weight: 700;
            margin: 10px 0;
            line-height: 1.3;
        }

        .result-card .score {
            font-size: 20px;
            line-height: 1.5;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            margin: 20px 0;
            border: 2px solid #f3e8ff;
            box-shadow: 0 4px 15px rgba(107, 91, 149, 0.08);
        }

        .info-box {
            background: #fef9ff;
            border: 2px solid #e8d5f2;
            padding: 18px;
            border-radius: 12px;
            margin: 20px 0;
            font-size: 15px;
            color: #6b5b95;
            line-height: 1.6;
        }

        .calc-box {
            background: white;
            border: 2px solid #e8d5f2;
            padding: 20px;
            border-radius: 12px;
            margin: 10px 0;
            font-family: 'Quicksand', sans-serif;
            font-size: 15px;
            line-height: 1.8;
            color: #6b5b95;
        }

        .calc-step {
            margin: 5px 0;
            color: #6b5b95;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .saved-projects {
            margin-top: 30px;
        }

        .project-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .project-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .project-title {
            font-weight: 700;
            font-size: 18px;
            color: #333;
        }

        .project-date {
            font-size: 12px;
            color: #666;
        }

        .project-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
            margin-top: 8px;
        }

        .badge-alt {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-crit {
            background: #fef3c7;
            color: #92400e;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s;
        }

        .toast.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success {
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .toast-error {
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }

        .form-group label input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .form-group label {
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        h2 {
            font-size: 26px;
            font-weight: 700;
            color: #6b5b95;
            margin: 30px 0 20px 0;
            text-transform: none;
            line-height: 1.4;
        }

        h3 {
            font-size: 20px;
            font-weight: 600;
            color: #6b5b95;
            margin: 25px 0 15px 0;
            line-height: 1.4;
        }

        h4 {
            font-size: 17px;
            font-weight: 600;
            color: #6b5b95;
            margin: 15px 0 10px 0;
            line-height: 1.4;
        }

        strong {
            font-weight: 700;
            color: #6b5b95;
        }

        @media (max-width: 768px) {
            .main-card {
                padding: 20px;
            }

            .header h1 {
                font-size: 16px;
            }

            .header p {
                font-size: 8px;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .step-label {
                font-size: 7px;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            h2 {
                font-size: 12px;
            }

            h3 {
                font-size: 10px;
            }
        }
    </style>
    <style>
        @view-transition {
            navigation: auto;
        }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>

<body>
    <div class="app-container">
        <div class="header">
            <h1 id="app-title">Fuzzy Weighted Product Calculator</h1>
            <p id="app-subtitle">Sistem Pendukung Keputusan Berbasis Fuzzy Logic</p>
        </div>
        <div class="main-card">
            <div class="step-indicator">
                <div class="step active" data-step="1">
                    <div class="step-circle">
                        1
                    </div>
                    <div class="step-label">
                        Setup
                    </div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-circle">
                        2
                    </div>
                    <div class="step-label">
                        Alternatif
                    </div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-circle">
                        3
                    </div>
                    <div class="step-label">
                        Kriteria
                    </div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-circle">
                        4
                    </div>
                    <div class="step-label">
                        Rating
                    </div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-circle">
                        5
                    </div>
                    <div class="step-label">
                        Hasil
                    </div>
                </div>
            </div><!-- Step 1: Setup -->
            <div class="content-section active" data-section="1">
                <h2>Setup Awal Proyek</h2>
                <div class="info-box">
                    Mulai dengan memasukkan nama proyek dan jumlah alternatif serta kriteria yang akan dievaluasi.
                </div>
                <div class="form-group"><label for="projectName">Nama Proyek</label> <input type="text" id="projectName"
                        placeholder="Contoh: Pemilihan Smartphone Terbaik">
                </div>
                <div class="input-row">
                    <div class="form-group"><label for="numAlternatives">Jumlah Alternatif (m)</label> <input
                            type="number" id="numAlternatives" min="2" value="3" placeholder="Minimal 2">
                    </div>
                    <div class="form-group"><label for="numCriteria">Jumlah Kriteria (n)</label> <input type="number"
                            id="numCriteria" min="2" value="3" placeholder="Minimal 2">
                    </div>
                </div>
                <div class="btn-group"><button class="btn btn-primary" onclick="nextStep()">Lanjut ke Alternatif
                        ‚Üí</button>
                </div>
            </div><!-- Step 2: Alternatives -->
            <div class="content-section" data-section="2">
                <h2>Input Nama Alternatif</h2>
                <div class="info-box">
                    Masukkan nama-nama alternatif yang akan dibandingkan.
                </div>
                <div id="alternativesInputs"></div>
                <div class="btn-group"><button class="btn btn-secondary" onclick="prevStep()">‚Üê Kembali</button> <button
                        class="btn btn-primary" onclick="nextStep()">Lanjut ke Kriteria ‚Üí</button>
                </div>
            </div><!-- Step 3: Criteria -->
            <div class="content-section" data-section="3">
                <h2>Input Kriteria dan Bobot</h2>
                <div class="info-box">
                    Masukkan nama kriteria, bobot preferensi, dan tipe atribut (benefit/cost).
                </div>
                <div id="criteriaInputs"></div>
                <h3 style="margin-top: 30px;">Pengaturan Domain Kuartil</h3>
                <div class="info-box">
                    Pilih metode perhitungan domain kuartil untuk setiap kriteria.
                </div>
                <div class="form-group"><label> <input type="radio" name="quartileMethod" value="auto" checked
                            onchange="toggleQuartileInputs()"> <strong>Otomatis</strong> - Sistem menghitung Min, Q1,
                        Q2, Q3, Max dari data rating </label>
                </div>
                <div class="form-group"><label> <input type="radio" name="quartileMethod" value="manual"
                            onchange="toggleQuartileInputs()"> <strong>Manual</strong> - Tentukan sendiri nilai domain
                        kuartil untuk setiap kriteria </label>
                </div>
                <div id="manualQuartileInputs" style="display: none; margin-top: 20px;"></div>
                <div class="btn-group"><button class="btn btn-secondary" onclick="prevStep()">‚Üê Kembali</button> <button
                        class="btn btn-primary" onclick="nextStep()">Lanjut ke Rating ‚Üí</button>
                </div>
            </div><!-- Step 4: Ratings -->
            <div class="content-section" data-section="4">
                <h2>Input Rating Kecocokan</h2>
                <div class="info-box">
                    Masukkan rating untuk setiap alternatif berdasarkan kriteria. Gunakan nilai linguistik (sangat
                    rendah, rendah, cukup, tinggi, sangat tinggi), nilai fuzzy (0-1), atau nilai numerik/rupiah (contoh:
                    2000, 20000, 150000).
                </div>
                <div id="ratingsTable"></div>
                <div class="btn-group"><button class="btn btn-secondary" onclick="prevStep()">‚Üê Kembali</button> <button
                        class="btn btn-success" onclick="calculate()">Hitung Hasil üöÄ</button>
                </div>
            </div><!-- Step 5: Results -->
            <div class="content-section" data-section="5">
                <h2>Hasil Perhitungan FWP</h2>
                <div class="result-card">
                    <h2>üèÜ Alternatif Terbaik</h2>
                    <div class="winner" id="winnerName">
                        -
                    </div>
                    <div class="score">
                        Skor V: <span id="winnerScore">-</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="resultChart"></canvas>
                </div>
                <h3>üìä Langkah 1: Konversi Rating ke Fuzzy</h3>
                <div class="info-box">
                    Setiap rating linguistik atau numerik dikonversi ke nilai fuzzy (0-1).
                </div>
                <div class="table-container" id="conversionTableContainer"></div>
                <h3>üìä Langkah 2: Perhitungan Domain Kuartil</h3>
                <div class="info-box">
                    Menghitung Min, Q1, Q2 (Median), Q3, dan Max untuk setiap kriteria berdasarkan data fuzzy.
                </div>
                <div class="table-container" id="quartileTableContainer"></div>
                <div id="quartileCalculationsContainer"></div>
                <h3>üìä Langkah 3: Matriks Fuzzy Ternormalisasi</h3>
                <div class="info-box">
                    Matriks keputusan dengan nilai fuzzy untuk setiap alternatif dan kriteria.
                </div>
                <div class="table-container" id="fuzzyMatrixContainer"></div>
                <h3>üìä Langkah 4: Normalisasi Bobot</h3>
                <div class="info-box">
                    Bobot preferensi dinormalisasi agar total = 1. Formula: W<sub>j</sub> = W'<sub>j</sub> /
                    Œ£W'<sub>j</sub>
                </div>
                <div class="table-container" id="weightsTableContainer"></div>
                <h3>üìä Langkah 5: Perhitungan Eksponen</h3>
                <div class="info-box">
                    Eksponen = +W<sub>j</sub> untuk benefit, -W<sub>j</sub> untuk cost
                </div>
                <div class="table-container" id="exponentsTableContainer"></div>
                <h3>üìä Langkah 6: Perhitungan Nilai S (Preferensi)</h3>
                <div class="info-box">
                    S<sub>i</sub> = ‚àè<sub>j=1</sub><sup>n</sup> (X<sub>ij</sub>)<sup>W<sub>j</sub></sup>
                </div>
                <div id="sCalculationsContainer"></div>
                <h3>üìä Langkah 7: Perhitungan Nilai V (Normalisasi)</h3>
                <div class="info-box">
                    V<sub>i</sub> = S<sub>i</sub> / Œ£S<sub>i</sub>
                </div>
                <div id="vCalculationsContainer"></div>
                <h3>üìä Langkah 8: Ranking Final</h3>
                <div class="table-container">
                    <table id="detailTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Alternatif</th>
                                <th>S (Preferensi)</th>
                                <th>V (Nilai)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="btn-group"><button class="btn btn-secondary" onclick="resetCalculation()">‚Üê Kembali ke
                        Rating</button> <button class="btn btn-primary" onclick="resetAll()">üîÑ Proyek Baru</button>
                </div>
            </div>
        </div>
    </div>
    <div class="toast" id="toast"><span id="toastMessage"></span>
    </div>
    <script>
        // Linguistic to Fuzzy mapping
        const LINGUISTIC_TO_FUZZY = {
            "sangat rendah": 0.2,
            "rendah": 0.4,
            "cukup": 0.6,
            "tinggi": 0.8,
            "sangat tinggi": 1.0,
            "1": 0.2,
            "2": 0.4,
            "3": 0.6,
            "4": 0.8,
            "5": 1.0
        };

        // Store numeric ratings for each criterion (for rupiah normalization)
        let numericRatings = [];

        // State
        let currentStep = 1;
        let projectData = {
            name: '',
            alternatives: [],
            criteria: [],
            weights: [],
            attributes: [],
            ratings: [],
            originalRatings: [],
            results: null,
            quartileMethod: 'auto',
            manualQuartiles: []
        };

        let resultChart = null;

        // Config for editable features
        const defaultConfig = {
            app_title: "Fuzzy Weighted Product Calculator",
            subtitle: "Sistem Pendukung Keputusan Berbasis Fuzzy Logic",
            background_color: "#fbc2eb",
            surface_color: "#ffffff",
            text_color: "#6b5b95",
            primary_action_color: "#a6c1ee",
            secondary_action_color: "#e8d5f2",
            font_family: "Quicksand",
            font_size: 16
        };

        // Initialize SDKs
        async function initializeSDKs() {
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (config) => {
                        document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
                        document.getElementById('app-subtitle').textContent = config.subtitle || defaultConfig.subtitle;

                        const customFont = config.font_family || defaultConfig.font_family;
                        const baseSize = config.font_size || defaultConfig.font_size;
                        const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';

                        document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
                        document.body.style.fontSize = `${baseSize}px`;

                        document.querySelectorAll('h1').forEach(el => el.style.fontSize = `${baseSize * 2.5}px`);
                        document.querySelectorAll('h2').forEach(el => el.style.fontSize = `${baseSize * 1.5}px`);
                        document.querySelectorAll('h3').forEach(el => el.style.fontSize = `${baseSize * 1.2}px`);

                        const bgColor = config.background_color || defaultConfig.background_color;
                        document.body.style.background = `linear-gradient(135deg, ${bgColor} 0%, #764ba2 100%)`;

                        const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
                        document.querySelectorAll('.btn-primary').forEach(el => el.style.backgroundColor = primaryColor);
                        document.querySelectorAll('th').forEach(el => el.style.backgroundColor = primaryColor);

                        const secondaryColor = config.secondary_action_color || defaultConfig.secondary_action_color;
                        document.querySelectorAll('.btn-success').forEach(el => el.style.backgroundColor = secondaryColor);
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [
                            {
                                get: () => config.background_color || defaultConfig.background_color,
                                set: (value) => {
                                    if (window.elementSdk) {
                                        window.elementSdk.config.background_color = value;
                                        window.elementSdk.setConfig({ background_color: value });
                                    }
                                }
                            },
                            {
                                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                                set: (value) => {
                                    if (window.elementSdk) {
                                        window.elementSdk.config.primary_action_color = value;
                                        window.elementSdk.setConfig({ primary_action_color: value });
                                    }
                                }
                            },
                            {
                                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                                set: (value) => {
                                    if (window.elementSdk) {
                                        window.elementSdk.config.secondary_action_color = value;
                                        window.elementSdk.setConfig({ secondary_action_color: value });
                                    }
                                }
                            }
                        ],
                        borderables: [],
                        fontEditable: {
                            get: () => config.font_family || defaultConfig.font_family,
                            set: (value) => {
                                if (window.elementSdk) {
                                    window.elementSdk.config.font_family = value;
                                    window.elementSdk.setConfig({ font_family: value });
                                }
                            }
                        },
                        fontSizeable: {
                            get: () => config.font_size || defaultConfig.font_size,
                            set: (value) => {
                                if (window.elementSdk) {
                                    window.elementSdk.config.font_size = value;
                                    window.elementSdk.setConfig({ font_size: value });
                                }
                            }
                        }
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["app_title", config.app_title || defaultConfig.app_title],
                        ["subtitle", config.subtitle || defaultConfig.subtitle]
                    ])
                });
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toast.className = `toast toast-${type} show`;
            toastMessage.textContent = message;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Step navigation
        function updateStepIndicator() {
            document.querySelectorAll('.step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.remove('active', 'completed');

                if (stepNum === currentStep) {
                    step.classList.add('active');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                }
            });

            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelector(`[data-section="${currentStep}"]`).classList.add('active');
        }

        function nextStep() {
            if (currentStep === 1) {
                const name = document.getElementById('projectName').value.trim();
                const numAlt = parseInt(document.getElementById('numAlternatives').value);
                const numCrit = parseInt(document.getElementById('numCriteria').value);

                if (!name) {
                    showToast('Masukkan nama proyek!', 'error');
                    return;
                }
                if (numAlt < 2 || numCrit < 2) {
                    showToast('Minimal 2 alternatif dan 2 kriteria!', 'error');
                    return;
                }

                projectData.name = name;
                generateAlternativesInputs(numAlt);
            } else if (currentStep === 2) {
                if (!collectAlternatives()) return;
                generateCriteriaInputs(parseInt(document.getElementById('numCriteria').value));
            } else if (currentStep === 3) {
                if (!collectCriteria()) return;
                generateRatingsTable();
            } else if (currentStep === 4) {
                if (!collectRatings()) return;
            }

            currentStep++;
            updateStepIndicator();
            window.scrollTo(0, 0);
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepIndicator();
                window.scrollTo(0, 0);
            }
        }

        // Generate alternatives inputs
        function generateAlternativesInputs(num) {
            const container = document.getElementById('alternativesInputs');
            container.innerHTML = '';

            for (let i = 0; i < num; i++) {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label for="alt${i}">Alternatif ${i + 1}</label>
                    <input type="text" id="alt${i}" placeholder="Contoh: Alternatif" value="${projectData.alternatives[i] || ''}">
                `;
                container.appendChild(div);
            }
        }

        function collectAlternatives() {
            const num = parseInt(document.getElementById('numAlternatives').value);
            const alternatives = [];

            for (let i = 0; i < num; i++) {
                const val = document.getElementById(`alt${i}`).value.trim();
                if (!val) {
                    showToast(`Masukkan nama alternatif ${i + 1}!`, 'error');
                    return false;
                }
                alternatives.push(val);
            }

            projectData.alternatives = alternatives;
            return true;
        }

        // Generate criteria inputs
        function generateCriteriaInputs(num) {
            const container = document.getElementById('criteriaInputs');
            container.innerHTML = '';

            for (let i = 0; i < num; i++) {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.style.background = '#f8f9fa';
                div.style.padding = '20px';
                div.style.borderRadius = '10px';
                div.style.marginBottom = '20px';
                div.innerHTML = `
                    <h4 style="margin-top: 0;">Kriteria ${i + 1}</h4>
                    <label for="crit${i}">Nama Kriteria</label>
                    <input type="text" id="crit${i}" placeholder="Contoh: Harga" value="${projectData.criteria[i] || ''}" style="margin-bottom: 15px;">
                    
                    <label for="weight${i}">Bobot Preferensi (W')</label>
                    <select id="weight${i}" style="margin-bottom: 15px;">
                        <option value="0.2">Sangat Rendah (0.2)</option>
                        <option value="0.4">Rendah (0.4)</option>
                        <option value="0.6" selected>Cukup (0.6)</option>
                        <option value="0.8">Tinggi (0.8)</option>
                        <option value="1.0">Sangat Tinggi (1.0)</option>
                    </select>
                    
                    <label for="attr${i}">Atribut</label>
                    <select id="attr${i}">
                        <option value="benefit" selected>Benefit (semakin tinggi semakin baik)</option>
                        <option value="cost">Cost (semakin rendah semakin baik)</option>
                    </select>
                `;
                container.appendChild(div);

                if (projectData.weights[i]) {
                    document.getElementById(`weight${i}`).value = projectData.weights[i];
                }
                if (projectData.attributes[i]) {
                    document.getElementById(`attr${i}`).value = projectData.attributes[i];
                }
            }
        }

        function collectCriteria() {
            const num = parseInt(document.getElementById('numCriteria').value);
            const criteria = [];
            const weights = [];
            const attributes = [];

            for (let i = 0; i < num; i++) {
                const name = document.getElementById(`crit${i}`).value.trim();
                if (!name) {
                    showToast(`Masukkan nama kriteria ${i + 1}!`, 'error');
                    return false;
                }
                criteria.push(name);
                weights.push(parseFloat(document.getElementById(`weight${i}`).value));
                attributes.push(document.getElementById(`attr${i}`).value);
            }

            projectData.criteria = criteria;
            projectData.weights = weights;
            projectData.attributes = attributes;

            // Collect quartile method and manual values if applicable
            const method = document.querySelector('input[name="quartileMethod"]:checked').value;
            projectData.quartileMethod = method;

            if (method === 'manual') {
                const manualQuartiles = [];
                for (let i = 0; i < num; i++) {
                    const min = parseFloat(document.getElementById(`q_min_${i}`).value);
                    const q1 = parseFloat(document.getElementById(`q_q1_${i}`).value);
                    const q2 = parseFloat(document.getElementById(`q_q2_${i}`).value);
                    const q3 = parseFloat(document.getElementById(`q_q3_${i}`).value);
                    const max = parseFloat(document.getElementById(`q_max_${i}`).value);

                    if (isNaN(min) || isNaN(q1) || isNaN(q2) || isNaN(q3) || isNaN(max)) {
                        showToast(`Lengkapi semua nilai kuartil untuk ${criteria[i]}!`, 'error');
                        return false;
                    }

                    if (!(min <= q1 && q1 <= q2 && q2 <= q3 && q3 <= max)) {
                        showToast(`Urutan kuartil ${criteria[i]} tidak valid! (Min ‚â§ Q1 ‚â§ Q2 ‚â§ Q3 ‚â§ Max)`, 'error');
                        return false;
                    }

                    manualQuartiles.push({ min, q1, q2, q3, max });
                }
                projectData.manualQuartiles = manualQuartiles;
            }

            return true;
        }

        function toggleQuartileInputs() {
            const method = document.querySelector('input[name="quartileMethod"]:checked').value;
            const container = document.getElementById('manualQuartileInputs');

            if (method === 'manual') {
                generateManualQuartileInputs();
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        function generateManualQuartileInputs() {
            const container = document.getElementById('manualQuartileInputs');
            const num = parseInt(document.getElementById('numCriteria').value);
            container.innerHTML = '';

            for (let i = 0; i < num; i++) {
                const criteriaName = document.getElementById(`crit${i}`).value.trim() || `Kriteria ${i + 1}`;

                const div = document.createElement('div');
                div.className = 'form-group';
                div.style.background = '#fff3cd';
                div.style.padding = '20px';
                div.style.borderRadius = '10px';
                div.style.marginBottom = '20px';
                div.style.border = '2px solid #ffc107';

                const existingQ = projectData.manualQuartiles[i] || { min: 0, q1: 0.25, q2: 0.5, q3: 0.75, max: 1 };

                div.innerHTML = `
                    <h4 style="margin-top: 0; color: #856404;">üìä Domain Kuartil: ${criteriaName}</h4>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px;">
                        <div>
                            <label for="q_min_${i}" style="font-size: 13px;">Min</label>
                            <input type="number" id="q_min_${i}" step="0.01" value="${existingQ.min}" placeholder="0.0" style="width: 100%;" onchange="autoFillQuartiles(${i})">
                        </div>
                        <div>
                            <label for="q_q1_${i}" style="font-size: 13px;">Q1</label>
                            <input type="number" id="q_q1_${i}" step="0.01" value="${existingQ.q1}" placeholder="0.25" style="width: 100%;">
                        </div>
                        <div>
                            <label for="q_q2_${i}" style="font-size: 13px;">Q2 (Median)</label>
                            <input type="number" id="q_q2_${i}" step="0.01" value="${existingQ.q2}" placeholder="0.5" style="width: 100%;">
                        </div>
                        <div>
                            <label for="q_q3_${i}" style="font-size: 13px;">Q3</label>
                            <input type="number" id="q_q3_${i}" step="0.01" value="${existingQ.q3}" placeholder="0.75" style="width: 100%;">
                        </div>
                        <div>
                            <label for="q_max_${i}" style="font-size: 13px;">Max</label>
                            <input type="number" id="q_max_${i}" step="0.01" value="${existingQ.max}" placeholder="1.0" style="width: 100%;" onchange="autoFillQuartiles(${i})">
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #856404;">
                        üí° <strong>Otomatis:</strong> Masukkan Min & Max, Q1/Q2/Q3 akan terisi otomatis | ‚ö†Ô∏è Urutan harus: Min ‚â§ Q1 ‚â§ Q2 ‚â§ Q3 ‚â§ Max
                    </div>
                `;
                container.appendChild(div);
            }
        }

        function autoFillQuartiles(index) {
            const minInput = document.getElementById(`q_min_${index}`);
            const maxInput = document.getElementById(`q_max_${index}`);
            const q1Input = document.getElementById(`q_q1_${index}`);
            const q2Input = document.getElementById(`q_q2_${index}`);
            const q3Input = document.getElementById(`q_q3_${index}`);

            const min = parseFloat(minInput.value);
            const max = parseFloat(maxInput.value);

            if (!isNaN(min) && !isNaN(max) && min < max) {
                const range = max - min;

                // Calculate Q1, Q2, Q3 as evenly distributed quartiles
                const q1 = min + (range * 0.25);
                const q2 = min + (range * 0.5);
                const q3 = min + (range * 0.75);

                q1Input.value = q1.toFixed(2);
                q2Input.value = q2.toFixed(2);
                q3Input.value = q3.toFixed(2);
            }
        }

        // Generate ratings table
        function generateRatingsTable() {
            const container = document.getElementById('ratingsTable');
            let html = '<div class="table-container"><table><thead><tr><th>Alternatif</th>';

            projectData.criteria.forEach(crit => {
                html += `<th>${crit}</th>`;
            });
            html += '</tr></thead><tbody>';

            projectData.alternatives.forEach((alt, i) => {
                html += `<tr><td><strong>${alt}</strong></td>`;
                projectData.criteria.forEach((crit, j) => {
                    const existingValue = projectData.ratings[i] ? projectData.ratings[i][j] : '';
                    html += `<td><input type="text" id="rating_${i}_${j}" placeholder="cukup / 0.6 / 20000" value="${existingValue}" style="width: 100%;"></td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function collectRatings() {
            const ratings = [];

            for (let i = 0; i < projectData.alternatives.length; i++) {
                const row = [];
                for (let j = 0; j < projectData.criteria.length; j++) {
                    const val = document.getElementById(`rating_${i}_${j}`).value.trim().toLowerCase();
                    if (!val) {
                        showToast(`Masukkan rating untuk ${projectData.alternatives[i]} - ${projectData.criteria[j]}!`, 'error');
                        return false;
                    }
                    row.push(val);
                }
                ratings.push(row);
            }

            projectData.ratings = ratings;
            return true;
        }

        // Fuzzy calculation
        function convertToFuzzy(value, criterionIndex) {
            const val = value.trim().toLowerCase();

            // Check linguistic value
            if (LINGUISTIC_TO_FUZZY[val] !== undefined) {
                return { fuzzy: LINGUISTIC_TO_FUZZY[val], numeric: null, type: 'linguistic' };
            }

            const num = parseFloat(val);
            if (!isNaN(num)) {
                // If between 0-1, treat as fuzzy
                if (num >= 0 && num <= 1) {
                    return { fuzzy: num, numeric: null, type: 'fuzzy' };
                }
                // If greater than 1, treat as numeric (rupiah)
                if (num > 1) {
                    return { fuzzy: null, numeric: num, type: 'numeric' };
                }
            }

            showToast(`Nilai tidak valid: ${value}. Gunakan linguistik, fuzzy (0-1), atau numerik (>1)`, 'error');
            return null;
        }

        function normalizeNumericRatings(numericData, criterionIndex) {
            // Get all numeric values for this criterion
            const values = numericData.map(row => row[criterionIndex]).filter(v => v !== null);

            if (values.length === 0) return [];

            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = max - min;

            // Normalize to 0.2-1.0 range (to match fuzzy scale: sangat rendah=0.2 to sangat tinggi=1.0)
            return numericData.map(row => {
                if (row[criterionIndex] === null) return null;

                if (range === 0) return 0.6; // All values are the same, return middle value (cukup)

                // Check if this is a cost or benefit criterion
                const isCost = projectData.attributes[criterionIndex] === 'cost';

                // Always normalize linearly: Min = 0.2 (Worst on scale), Max = 1.0 (Best on scale)
                // BUT for Cost, this means High Price = 1.0 (High Fuzzy), Low Price = 0.2 (Low Fuzzy)
                // The negative exponent in Weighted Product will handle the preference reversal:
                // Cost (High Price, 1.0) ^ -W = Small number (Low preference)
                // Cost (Low Price, 0.2) ^ -W = Large number (High preference)
                return 0.2 + (0.8 * ((row[criterionIndex] - min) / range));
            });
        }

        function calculateQuartile(sortedArray, position) {
            const n = sortedArray.length;
            const index = position * (n - 1);
            const lower = Math.floor(index);
            const upper = Math.ceil(index);
            const weight = index - lower;

            if (lower === upper) {
                return sortedArray[lower];
            }

            return sortedArray[lower] * (1 - weight) + sortedArray[upper] * weight;
        }

        function calculateQuartiles(data) {
            const sorted = [...data].sort((a, b) => a - b);
            const n = sorted.length;

            const min = sorted[0];
            const max = sorted[n - 1];
            const q1 = calculateQuartile(sorted, 0.25);
            const q2 = calculateQuartile(sorted, 0.5);
            const q3 = calculateQuartile(sorted, 0.75);

            return { min, q1, q2, q3, max, sorted, n };
        }

        function normalizeWeights(weights) {
            const sum = weights.reduce((a, b) => a + b, 0);
            return weights.map(w => w / sum);
        }

        function calculate() {
            if (!collectRatings()) return;

            projectData.originalRatings = JSON.parse(JSON.stringify(projectData.ratings));

            // Convert ratings to fuzzy
            const fuzzyMatrix = [];
            numericRatings = [];

            // First pass: collect all data and identify numeric columns
            const conversionData = [];
            const hasNumericPerCriterion = [];

            for (let j = 0; j < projectData.criteria.length; j++) {
                let hasNumeric = false;
                for (let i = 0; i < projectData.ratings.length; i++) {
                    const converted = convertToFuzzy(projectData.ratings[i][j], j);
                    if (converted === null) return;

                    if (!conversionData[i]) conversionData[i] = [];
                    conversionData[i][j] = converted;

                    if (converted.type === 'numeric') {
                        hasNumeric = true;
                    }
                }
                hasNumericPerCriterion[j] = hasNumeric;
            }

            // Second pass: build numeric matrix and fuzzy matrix
            for (let i = 0; i < projectData.ratings.length; i++) {
                const numericRow = [];
                for (let j = 0; j < projectData.ratings[i].length; j++) {
                    if (hasNumericPerCriterion[j] && conversionData[i][j].type === 'numeric') {
                        numericRow.push(conversionData[i][j].numeric);
                    } else {
                        numericRow.push(null);
                    }
                }
                numericRatings.push(numericRow);
            }

            // Normalize numeric columns and build final fuzzy matrix
            for (let j = 0; j < projectData.criteria.length; j++) {
                if (hasNumericPerCriterion[j]) {
                    const normalized = normalizeNumericRatings(numericRatings, j);
                    for (let i = 0; i < projectData.ratings.length; i++) {
                        if (!fuzzyMatrix[i]) fuzzyMatrix[i] = [];
                        fuzzyMatrix[i][j] = normalized[i];
                    }
                } else {
                    for (let i = 0; i < projectData.ratings.length; i++) {
                        if (!fuzzyMatrix[i]) fuzzyMatrix[i] = [];
                        fuzzyMatrix[i][j] = conversionData[i][j].fuzzy;
                    }
                }
            }

            projectData.conversionData = conversionData;
            projectData.hasNumericPerCriterion = hasNumericPerCriterion;

            // Calculate quartiles for each criterion
            const quartiles = [];
            for (let j = 0; j < projectData.criteria.length; j++) {
                let quartileData;

                if (projectData.quartileMethod === 'manual') {
                    // Use manual quartile values
                    const manual = projectData.manualQuartiles[j];
                    const columnData = fuzzyMatrix.map(row => row[j]);
                    const sorted = [...columnData].sort((a, b) => a - b);
                    quartileData = {
                        min: manual.min,
                        q1: manual.q1,
                        q2: manual.q2,
                        q3: manual.q3,
                        max: manual.max,
                        sorted: sorted,
                        n: sorted.length,
                        isManual: true
                    };
                } else {
                    // Calculate automatically from data
                    const columnData = fuzzyMatrix.map(row => row[j]);
                    quartileData = calculateQuartiles(columnData);
                    quartileData.isManual = false;
                }

                quartiles.push(quartileData);
            }

            // Normalize weights
            const normalizedWeights = normalizeWeights(projectData.weights);

            // Calculate exponents
            const exponents = normalizedWeights.map((w, i) =>
                projectData.attributes[i] === 'benefit' ? w : -w
            );

            // Calculate S values
            const sValues = fuzzyMatrix.map(row => {
                let s = 1;
                for (let j = 0; j < row.length; j++) {
                    s *= Math.pow(row[j], exponents[j]);
                }
                return s;
            });

            // Calculate V values
            const sSum = sValues.reduce((a, b) => a + b, 0);
            const vValues = sValues.map(s => s / sSum);

            // Rank
            const results = projectData.alternatives.map((alt, i) => ({
                alternative: alt,
                s: sValues[i],
                v: vValues[i],
                fuzzyRatings: fuzzyMatrix[i]
            }));

            results.sort((a, b) => b.v - a.v);
            results.forEach((r, i) => r.rank = i + 1);

            projectData.results = results;
            projectData.normalizedWeights = normalizedWeights;
            projectData.exponents = exponents;
            projectData.fuzzyMatrix = fuzzyMatrix;
            projectData.quartiles = quartiles;
            projectData.sSum = sSum;

            currentStep = 5;
            updateStepIndicator();
            displayResults();
            window.scrollTo(0, 0);
        }

        // Display results
        function displayResults() {
            const results = projectData.results;

            // Winner card
            document.getElementById('winnerName').textContent = results[0].alternative;
            document.getElementById('winnerScore').textContent = results[0].v.toFixed(4);

            // Step 1: Conversion Table
            displayConversionTable();

            // Step 2: Quartile Calculations
            displayQuartileTable();
            displayQuartileCalculations();

            // Step 3: Fuzzy matrix
            displayFuzzyMatrix();

            // Step 4: Weights normalization
            displayWeightsTable();

            // Step 5: Exponents
            displayExponentsTable();

            // Step 6: S calculations
            displaySCalculations();

            // Step 7: V calculations
            displayVCalculations();

            // Step 8: Final ranking
            const tbody = document.querySelector('#detailTable tbody');
            tbody.innerHTML = '';

            results.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${r.rank}</strong></td>
                    <td><strong>${r.alternative}</strong></td>
                    <td>${r.s.toFixed(6)}</td>
                    <td>${r.v.toFixed(6)}</td>
                `;
                tbody.appendChild(tr);
            });

            // Chart
            renderChart();
        }

        function displayConversionTable() {
            const container = document.getElementById('conversionTableContainer');
            let html = '<table><thead><tr><th>Alternatif</th>';

            projectData.criteria.forEach(c => html += `<th>${c}</th>`);
            html += '</tr></thead><tbody>';

            projectData.alternatives.forEach((alt, i) => {
                html += `<tr><td><strong>${alt}</strong></td>`;
                projectData.originalRatings[i].forEach((rating, j) => {
                    const fuzzyVal = projectData.fuzzyMatrix[i][j];
                    const convData = projectData.conversionData[i][j];

                    let displayText = rating;
                    if (convData.type === 'numeric') {
                        // Show normalization process for numeric values
                        const numericVals = numericRatings.map(row => row[j]).filter(v => v !== null);
                        const min = Math.min(...numericVals);
                        const max = Math.max(...numericVals);
                        const range = max - min;
                        const isCost = projectData.attributes[j] === 'cost';

                        if (range === 0) {
                            displayText = `${rating} ‚Üí [Semua sama] ‚Üí <strong>${fuzzyVal.toFixed(4)}</strong>`;
                        } else if (isCost) {
                            // COST: Lower is better, handled by EXPONENT
                            // Normalization is standard (Low Cost -> Low Fuzzy)
                            displayText = `${rating} ‚Üí <span style="color: #d65076;">[COST: Lebih rendah = Lebih baik]</span><br>`;
                            displayText += `<small>(Dihandle oleh eksponen negatif)</small><br>`;
                            displayText += `Formula: 0.2 + 0.8 √ó (X - Min) / (Max - Min)<br>`;
                            displayText += `= 0.2 + 0.8 √ó (${rating} - ${min}) / (${max} - ${min})<br>`;
                            displayText += `= 0.2 + 0.8 √ó ${(convData.numeric - min).toFixed(2)} / ${range.toFixed(2)}<br>`;
                            displayText += `= 0.2 + 0.8 √ó ${((convData.numeric - min) / range).toFixed(4)}<br>`;
                            displayText += `= <strong>${fuzzyVal.toFixed(4)}</strong>`;
                        } else {
                            // BENEFIT: Higher is better
                            displayText = `${rating} ‚Üí <span style="color: #10b981;">[BENEFIT: Lebih tinggi = Lebih baik]</span><br>`;
                            displayText += `Formula: 0.2 + 0.8 √ó (X - Min) / (Max - Min)<br>`;
                            displayText += `= 0.2 + 0.8 √ó (${rating} - ${min}) / (${max} - ${min})<br>`;
                            displayText += `= 0.2 + 0.8 √ó ${(convData.numeric - min).toFixed(2)} / ${range.toFixed(2)}<br>`;
                            displayText += `= 0.2 + 0.8 √ó ${((convData.numeric - min) / range).toFixed(4)}<br>`;
                            displayText += `= <strong>${fuzzyVal.toFixed(4)}</strong>`;
                        }
                    } else {
                        displayText = `${rating} ‚Üí <strong>${fuzzyVal.toFixed(2)}</strong>`;
                    }

                    html += `<td>${displayText}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function displayQuartileTable() {
            const container = document.getElementById('quartileTableContainer');
            let html = '<table><thead><tr><th>Kriteria</th><th>Min</th><th>Q1</th><th>Q2 (Median)</th><th>Q3</th><th>Max</th></tr></thead><tbody>';

            projectData.criteria.forEach((crit, i) => {
                const q = projectData.quartiles[i];
                html += `<tr>
                    <td><strong>${crit}</strong></td>
                    <td>${q.min.toFixed(4)}</td>
                    <td>${q.q1.toFixed(4)}</td>
                    <td>${q.q2.toFixed(4)}</td>
                    <td>${q.q3.toFixed(4)}</td>
                    <td>${q.max.toFixed(4)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function displayQuartileCalculations() {
            const container = document.getElementById('quartileCalculationsContainer');
            container.innerHTML = '';

            if (projectData.quartileMethod === 'manual') {
                // Show manual input notice
                const noticeBox = document.createElement('div');
                noticeBox.className = 'info-box';
                noticeBox.style.background = '#fff3cd';
                noticeBox.style.borderColor = '#ffc107';
                noticeBox.style.color = '#856404';
                noticeBox.innerHTML = '<strong>üìù Mode Manual:</strong> Nilai kuartil ditentukan secara manual oleh pengguna.';
                container.appendChild(noticeBox);

                projectData.criteria.forEach((crit, i) => {
                    const q = projectData.quartiles[i];
                    const calcBox = document.createElement('div');
                    calcBox.className = 'calc-box';

                    let calcSteps = `<strong>${crit}:</strong><br>`;
                    calcSteps += `Data terurut: [${q.sorted.map(v => v.toFixed(2)).join(', ')}]<br>`;
                    calcSteps += `Jumlah data (n): ${q.n}<br><br>`;

                    calcSteps += `<strong>Nilai Manual:</strong><br>`;
                    calcSteps += `Min: ${q.min.toFixed(4)}<br>`;
                    calcSteps += `Q1: ${q.q1.toFixed(4)}<br>`;
                    calcSteps += `Q2 (Median): ${q.q2.toFixed(4)}<br>`;
                    calcSteps += `Q3: ${q.q3.toFixed(4)}<br>`;
                    calcSteps += `Max: ${q.max.toFixed(4)}`;

                    calcBox.innerHTML = calcSteps;
                    container.appendChild(calcBox);
                });
            } else {
                // Show automatic calculations
                projectData.criteria.forEach((crit, i) => {
                    const q = projectData.quartiles[i];
                    const calcBox = document.createElement('div');
                    calcBox.className = 'calc-box';

                    let calcSteps = `<strong>${crit}:</strong><br>`;
                    calcSteps += `Data terurut: [${q.sorted.map(v => v.toFixed(2)).join(', ')}]<br>`;
                    calcSteps += `Jumlah data (n): ${q.n}<br><br>`;

                    calcSteps += `<strong>Min:</strong> ${q.min.toFixed(4)}<br>`;
                    calcSteps += `<strong>Max:</strong> ${q.max.toFixed(4)}<br><br>`;

                    // Q1 calculation
                    const q1_pos = 0.25 * (q.n - 1);
                    const q1_lower = Math.floor(q1_pos);
                    const q1_upper = Math.ceil(q1_pos);
                    calcSteps += `<strong>Q1 (Kuartil Bawah):</strong><br>`;
                    calcSteps += `Posisi = 0.25 √ó (${q.n} - 1) = ${q1_pos.toFixed(2)}<br>`;
                    if (q1_lower === q1_upper) {
                        calcSteps += `Q1 = data[${q1_lower}] = ${q.q1.toFixed(4)}<br><br>`;
                    } else {
                        const weight = q1_pos - q1_lower;
                        calcSteps += `Q1 = data[${q1_lower}] √ó ${(1 - weight).toFixed(2)} + data[${q1_upper}] √ó ${weight.toFixed(2)}<br>`;
                        calcSteps += `Q1 = ${q.sorted[q1_lower].toFixed(4)} √ó ${(1 - weight).toFixed(2)} + ${q.sorted[q1_upper].toFixed(4)} √ó ${weight.toFixed(2)} = ${q.q1.toFixed(4)}<br><br>`;
                    }

                    // Q2 calculation
                    const q2_pos = 0.5 * (q.n - 1);
                    const q2_lower = Math.floor(q2_pos);
                    const q2_upper = Math.ceil(q2_pos);
                    calcSteps += `<strong>Q2 (Median):</strong><br>`;
                    calcSteps += `Posisi = 0.5 √ó (${q.n} - 1) = ${q2_pos.toFixed(2)}<br>`;
                    if (q2_lower === q2_upper) {
                        calcSteps += `Q2 = data[${q2_lower}] = ${q.q2.toFixed(4)}<br><br>`;
                    } else {
                        const weight = q2_pos - q2_lower;
                        calcSteps += `Q2 = data[${q2_lower}] √ó ${(1 - weight).toFixed(2)} + data[${q2_upper}] √ó ${weight.toFixed(2)}<br>`;
                        calcSteps += `Q2 = ${q.sorted[q2_lower].toFixed(4)} √ó ${(1 - weight).toFixed(2)} + ${q.sorted[q2_upper].toFixed(4)} √ó ${weight.toFixed(2)} = ${q.q2.toFixed(4)}<br><br>`;
                    }

                    // Q3 calculation
                    const q3_pos = 0.75 * (q.n - 1);
                    const q3_lower = Math.floor(q3_pos);
                    const q3_upper = Math.ceil(q3_pos);
                    calcSteps += `<strong>Q3 (Kuartil Atas):</strong><br>`;
                    calcSteps += `Posisi = 0.75 √ó (${q.n} - 1) = ${q3_pos.toFixed(2)}<br>`;
                    if (q3_lower === q3_upper) {
                        calcSteps += `Q3 = data[${q3_lower}] = ${q.q3.toFixed(4)}`;
                    } else {
                        const weight = q3_pos - q3_lower;
                        calcSteps += `Q3 = data[${q3_lower}] √ó ${(1 - weight).toFixed(2)} + data[${q3_upper}] √ó ${weight.toFixed(2)}<br>`;
                        calcSteps += `Q3 = ${q.sorted[q3_lower].toFixed(4)} √ó ${(1 - weight).toFixed(2)} + ${q.sorted[q3_upper].toFixed(4)} √ó ${weight.toFixed(2)} = ${q.q3.toFixed(4)}`;
                    }

                    calcBox.innerHTML = calcSteps;
                    container.appendChild(calcBox);
                });
            }
        }

        function displayFuzzyMatrix() {
            const container = document.getElementById('fuzzyMatrixContainer');
            let html = '<table><thead><tr><th>Alternatif</th>';

            projectData.criteria.forEach(c => html += `<th>${c}</th>`);
            html += '</tr></thead><tbody>';

            projectData.results.forEach(r => {
                html += `<tr><td><strong>${r.alternative}</strong></td>`;
                r.fuzzyRatings.forEach(rating => {
                    html += `<td>${rating.toFixed(2)}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function displayWeightsTable() {
            const container = document.getElementById('weightsTableContainer');
            const weightSum = projectData.weights.reduce((a, b) => a + b, 0);

            let html = '<table><thead><tr><th>Kriteria</th><th>W\' (Original)</th><th>W (Normalized)</th><th>Perhitungan</th></tr></thead><tbody>';

            projectData.criteria.forEach((crit, i) => {
                html += `<tr>
                    <td><strong>${crit}</strong></td>
                    <td>${projectData.weights[i].toFixed(2)}</td>
                    <td><strong>${projectData.normalizedWeights[i].toFixed(6)}</strong></td>
                    <td>${projectData.weights[i].toFixed(2)} / ${weightSum.toFixed(2)} = ${projectData.normalizedWeights[i].toFixed(6)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function displayExponentsTable() {
            const container = document.getElementById('exponentsTableContainer');

            let html = '<table><thead><tr><th>Kriteria</th><th>W (Normalized)</th><th>Atribut</th><th>Eksponen</th></tr></thead><tbody>';

            projectData.criteria.forEach((crit, i) => {
                const sign = projectData.attributes[i] === 'benefit' ? '+' : '-';
                html += `<tr>
                    <td><strong>${crit}</strong></td>
                    <td>${projectData.normalizedWeights[i].toFixed(6)}</td>
                    <td>${projectData.attributes[i]}</td>
                    <td><strong>${sign}${projectData.normalizedWeights[i].toFixed(6)}</strong></td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function displaySCalculations() {
            const container = document.getElementById('sCalculationsContainer');
            container.innerHTML = '';

            projectData.alternatives.forEach((alt, i) => {
                const calcBox = document.createElement('div');
                calcBox.className = 'calc-box';

                let calcSteps = `<strong>S${i + 1} (${alt}):</strong><br>`;
                calcSteps += 'S = ';

                const parts = [];
                for (let j = 0; j < projectData.criteria.length; j++) {
                    const fuzzyVal = projectData.fuzzyMatrix[i][j];
                    const exp = projectData.exponents[j];
                    parts.push(`(${fuzzyVal.toFixed(2)})<sup>${exp.toFixed(4)}</sup>`);
                }
                calcSteps += parts.join(' √ó ');

                calcSteps += '<br>S = ';
                for (let j = 0; j < projectData.criteria.length; j++) {
                    const fuzzyVal = projectData.fuzzyMatrix[i][j];
                    const exp = projectData.exponents[j];
                    const result = Math.pow(fuzzyVal, exp);
                    if (j > 0) calcSteps += ' √ó ';
                    calcSteps += result.toFixed(6);
                }

                const sValue = projectData.results.find(r => r.alternative === alt).s;
                calcSteps += `<br><strong>S = ${sValue.toFixed(6)}</strong>`;

                calcBox.innerHTML = calcSteps;
                container.appendChild(calcBox);
            });
        }

        function displayVCalculations() {
            const container = document.getElementById('vCalculationsContainer');
            container.innerHTML = '';

            const calcBox = document.createElement('div');
            calcBox.className = 'calc-box';

            let calcSteps = '<strong>Perhitungan Œ£S:</strong><br>';
            calcSteps += 'Œ£S = ';
            const sParts = projectData.results.map(r => r.s.toFixed(6));
            calcSteps += sParts.join(' + ');
            calcSteps += `<br><strong>Œ£S = ${projectData.sSum.toFixed(6)}</strong><br><br>`;

            calcSteps += '<strong>Perhitungan Nilai V:</strong><br>';

            projectData.alternatives.forEach((alt, i) => {
                const result = projectData.results.find(r => r.alternative === alt);
                calcSteps += `<div class="calc-step">V${i + 1} (${alt}) = ${result.s.toFixed(6)} / ${projectData.sSum.toFixed(6)} = <strong>${result.v.toFixed(6)}</strong></div>`;
            });

            calcBox.innerHTML = calcSteps;
            container.appendChild(calcBox);
        }

        function renderChart() {
            const ctx = document.getElementById('resultChart');

            if (resultChart) {
                resultChart.destroy();
            }

            const results = projectData.results;

            resultChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: results.map(r => r.alternative),
                    datasets: [{
                        label: 'Nilai V (Preferensi)',
                        data: results.map(r => r.v),
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Perbandingan Nilai Preferensi Alternatif',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nilai V'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Alternatif'
                            }
                        }
                    }
                }
            });
        }

        function resetCalculation() {
            currentStep = 4;
            updateStepIndicator();
            window.scrollTo(0, 0);
        }

        function resetAll() {
            projectData = {
                name: '',
                alternatives: [],
                criteria: [],
                weights: [],
                attributes: [],
                ratings: [],
                originalRatings: [],
                results: null,
                quartileMethod: 'auto',
                manualQuartiles: []
            };

            document.getElementById('projectName').value = '';
            document.getElementById('numAlternatives').value = '3';
            document.getElementById('numCriteria').value = '3';

            currentStep = 1;
            updateStepIndicator();
            showToast('Siap untuk proyek baru! üîÑ', 'success');
            window.scrollTo(0, 0);
        }

        // Initialize
        initializeSDKs();
    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'9bfc31119504fcf3',t:'MTc2ODcxOTM3OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>